# Can协议

## CAN物理层

### 通讯节点

CAN总线上可以**挂载多个通讯节点**，节点之间的信号通过总线传输，实现节点间通讯。

CAN协议不对节点进行地址编码，而是对数据内容进行编码，所以节点个数理论上不受限制，只要总线的负载足够即可，而且可以通过中继器增强负载。

CAN通讯节点由一个CAN控制器和CAN收发器组成。

控制器与收发器之间通过CAN_Tx及CAN_Rx信号线相连

收发器与CAN总线之间使用CAN_High及CAN——Low信号线相连。

CAN_Tx 及 CAN_Rx 使用普通的类似 TTL 逻辑信号，而 CAN_High 及 CAN_Low 是一对差分信号线，使用比较特别的差分信号。

CAN节点发送数据时，控制器把要发送的二进制编码通过CAN_Tx线发送到收发器，由收发器把这个普通的逻辑电平信号转化成**差分信号**，通过差分线CAN_High和CAN_Low线输出到CAN总线网络。

而通过收发器接收到总线上的数据到控制器时，则是**相反的过程**，收发器把总线上收到的CAN_High及CAN_Low信号转化成**普通的逻辑电平信号**，通过CAN_Rx输出到控制器中。

### CAN 协议中的差分信号

![image.png](https://img-blog.csdnimg.cn/img_convert/3247c023be2cae8d94ec5d6fe86501d8.png)

在 CAN 总线中，必须使它处于隐性电平 (逻辑 1) 或显性电平 (逻辑 0) 中的其中一个状态。假如有两个 CAN 通讯节点，在同一时间，一个输出隐性电平，另一个输出显性电平，类似 I2C 总线的“线与”特性将使它处于显性电平状态，显性电平的名字就是这样来的，即可以认为显性具有优先的意味。

## CAN协议层

### 2.1 CAN的波特率及同步

CAN属于异步通讯，没有时钟信号线，连接在同一个总线网络的各个节点会像串口异步通讯那样，节点间使用约定好的波特率进行通讯。

### 2.2 位时序分解

为了实现位同步，CAN协议把每一个数据位的时序分解成如图所示的SS段、PTS段、PBS1段、PBS2段，这**四段加起来的长度**即为一个CAN数据位的长度。分解后最小的时间单位是Tq，而一个完整的位由8~25个Tq组成。为方便表示，图中的高低点评直接代表信号逻辑0或逻辑1（**不是差分信号**）。

![image.png](https://img-blog.csdnimg.cn/img_convert/ceba81092e291c244fcdd509b2c17803.png)

该图中表示的 CAN 通讯信号每一个数据位的长度为 19Tq，其中 SS 段占 1Tq， PTS 段占 6Tq， PBS1段占 5Tq， PBS2 段占 7Tq。信号的采样点位于 PBS1 段与 PBS2 段之间，通过控制各段的长度，可以对采样点的位置进行偏移，以便准确地采样。

各段的作用如介绍下：

#### SS段（SYNC SEG)

SS译为同步段，若通讯节点检测到总线上信号的跳变被包含在SS段的范围之内，则表示该节点与总线的时序是同步的，当节点与总线同步时，采样点采集到的总线电平即可被确定为该位的电平。SS段的大小固定为1Tq。

#### PTS段（PROP SEG)

PTS译为**传播时间段**，这个时间段是用于补偿网络的物理延时时间。是总线上输入比较器延时和输出驱动器延时总和的两倍。PTS段的大小可以为1~8Tq。

#### PBS1段（PHASE SEG1）

PBS1段为**相位缓冲段**，主要用来补偿边沿阶段的误差，它的时间长度在重新同步的时候可以加长。PBS1段的初始大小可以为1~8Tq。

#### PBS2段（PHASE SEG2）

PBS2为另一个**相位缓冲段**，用来补偿边沿阶段误差，时间长度在重新同步时可以缩短。PBS2段的初始大小可以为2~8Tq。

### 2.3 通讯的波特率

总线上的各个通讯节点只要约定好1个Tq的时间长度以及每一个数据位占据多少个Tq，就可以确定CAN通讯的波特率。

### 2.4 同步过程分析

波特率只是确定了每个数据位的长度，数据同步还涉及到对应的细节，这个时候就需要用到数据位内的SS,PTS,PBS1和PBS2段了。

根据对段的应用方式差异，CAN的数据同步分为**硬同步**和**重新同步**。其中硬同步只是当存在“帧起始信号”时起作用，无法确保后续一连串的位时序都是同步的，而重新同步方式可以解决该问题。两种方法具体介绍如下：

#### 2.4.1 硬同步

某个CAN节点通过总线发送数据时，它会发送一个表示通讯起始的信号，该信号是一个由高变低的下降沿。而挂载到CAN总线上的通讯节点在不发送数据时，会时刻检测总线上的信号。

![image.png](https://img-blog.csdnimg.cn/img_convert/870f7a3e5799d71586ca66ba78144afc.png)

如上图，可以看到当总线出现帧起始信号时，某节点检测到总线的帧起始信号不在节点内部时序的SS段范围，所以判断它自己的内部时序与总线不同步，所以这个采样点采集得到的数据是不正确的。所以节点以硬同步的方式调整，把自己的位时序中的SS段**平移至总线出现下降沿**的部分，获得同步，同步后采样点就可以采集得正确时序了。

#### 2.4.2 重新同步

前面的硬同步**只是当存在帧起始信号时才起作用**，如果在一帧很长的数据内，节点信号与总线信号相位有偏移时，这种同步方式就无能为力了。因而需要重新引入重新同步方式。

它利用普通数据位的高至低电平的跳变沿来同步（帧起始信号是特殊的跳变沿）。重新同步与硬同步相似的地方是它们都使用SS段来进行检测，同步的目的都是**使节点内的SS段**来进行检测，同步的目的都是使节点内的SS段把跳变沿包含起来。

![image.png](https://img-blog.csdnimg.cn/img_convert/d150b4f1c4fed0885f9aa00a553e2f6f.png)

重新同步的方式分为超前和滞后两种情况，以总线跳变沿与SS段的相对位置进行区分。

第一种相位超前的情况如图，节点从总线的边沿跳变中，检测到它内部的时许比总线的时序相对超前2Tq，这时控制器在下一个位时序中的PBS1段增加2tq的时间长度，使得节点与总线时序重新同步。

![image.png](https://img-blog.csdnimg.cn/img_convert/da2380e3b2526eb121556d9ea521ee2a.png)

第二种相位滞后的情况如图，节点从总线的边沿跳变中，检测到它的时序比总线的时序相对滞后2Tq，这时控制器在前一个位时序的PBS2段减少2Tq的时间长度，获得同步。

#### 小总结

在重新同步的时候，PBS1和PBS2中增加或减少的这段时间长度被定义为“重新同步补偿宽度SJW(reSynchronization Jump Width)”。一般来说CAN控制器会限定SJW的最大值，如限定了最大SJW=3Tq时，单次同步调整的时候**不能增加或减少超过3Tq的时间长度**，若有需要，控制器会通过多次小幅度调整来实现同步。

当控制器设置的SJW极限值较大时，可以吸收的误差加大，但通讯的速度会下降。

### 2.5 CAN的报文种类及结构

CAN 使用的是两条差分信号线，只能表达一个信号，简洁的物理层决定了 CAN 必然要配上一套更复杂的协议，如何用一个信号通道实现同样、甚至更强大的功能呢？CAN 协议给出的解决方案是对数据、操作命令 (如读/写) 以及同步信号进行打包，打包后的这些内容称为报文。

#### 2.5.1 报文的种类

原视数据段的前面加上传输起始标签、片选（识别）标签和控制标签，在数据的尾端加上CRC校验标签，应答标签和传输结束标签，把这些内容按照特定的格式打包好，就可以用一个通道表达各种信号了。

![image.png](https://img-blog.csdnimg.cn/img_convert/791df0d869ac7c43e90d290efabd315c.png)

#### 2.5.2 数据帧的结构

数据帧是在 CAN 通讯中最主要、最复杂的报文

![image.png](https://img-blog.csdnimg.cn/img_convert/271896f71e8db15a71eede85a5ecb2a8.png)

数据帧以一个显性位（逻辑0）开始，以7个连续的隐形位（逻辑1）结束，在它们之间，分别有仲裁段、控制段、数据段、CRC段和ACK段。

##### · 帧起始

SOF段（Start OfFrame），译为帧起始，帧起始信号只有一个数据位，是一个显性电平，用于通知各个节点将会有数据传输，其他节点通过帧起始信号的电平跳变来进行硬同步。

##### · 仲裁段

当有两个报文被发送时，总线会根据仲裁段的内容决定哪个数据包能被传输。

仲裁段的内容主要为：

①本数据帧的ID信息(标识符)

②数据帧具有标准格式和扩展格式两种，区别在于**ID信息的长度**。标准格式的ID为11位，扩展格式的ID为29位，它在标准ID的基础上多出18位。

在CAN协议中，ID起着重要的作用——决定数据帧发送的优先级，也决定着其他节点是否会接收这个数据帧。CAN协议不对挂载它之上的节点分配优先级和地址，对总线的占有权也是**由信息的重要性决定的**。即对于重要的信息，会打包上一个优先级高的ID。如果总线上同时出现显性电平和隐形电平，总线的状态会被置为显性电平，CAN正是利用这个特性进行仲裁。

若两个节点同时竞争CAN总线的占有权，当它们发送报文时，若首先**出现隐形电平**，则会失去对总线的占有权，进入接收状态。

![image.png](https://img-blog.csdnimg.cn/img_convert/7f5fb78e7aab3e2f479507ebcf682631.png)

在开始阶段，两个设备发送的电平一样，所以它们一直继续发送数据。到了图中箭头所指的时序处，节点单元 1 发送的为隐性电平，而此时节点单元 2 发送的为显性电平，由于总线的“线与”特性使它表达出显示电平，因此单元 2 竞争总线成功，这个报文得以被继续发送出去。

仲裁段ID的优先级也影响着接收设备对报文的反映。因为在CAN总线上数据是以广播的形式发送的，所有连接在CAN总线的节点都会接收到其他节点发出的有效数据，因此，CAN控制器大多具有根据ID过滤报文的共嗯，他可以控制自己只接受某些ID的报文。

仲裁段除了报文ID外，还有RTR,IDE和SRR位。

###### （1）RTR位：

RTR位（Remote Transmission Request Bit），译作远程传输请求位，它是**用于区分数据帧和遥控帧**的，当它为显性电平时表示数据帧，隐形电平时表示遥控帧。

###### （2）IDE位：

IDE位（Identifier Extension Bit），译作标识符扩展位，它是用于**区分标准格式与扩展格式**，当它为显性电平时为标准格式，隐形电平时为扩展格式。

###### （3）SRR位：

SRR位（Substitute Remote Request Bit），只存在于扩展格式，它用于替代标准格式中的RTR位。由于扩展帧中的SRR位为隐形位，RTR在数据帧为显性位，所以在两个ID相同的标准格式报文与扩展格式报文中，标准格式的优先级较高。

##### · 控制端

在控制段中的r1和r0为保留位，默认位置为显性位。它最主要的是DLC段（Data Length Code），译为数据长度码，它由4个数据位组成，用于表示本报文中的数据段含有多少个字节，DLC段表示的数字为0~8。

##### · 数据段

数据段为数据帧的核心内容，它是节点要发送的原始信息，由0~8个字节组成，MSB先行。

##### · CRC段

为了保证报文的正确传输，CAN的报文包含了一段15位的CRC校验码，一旦接收节点算出的CRC码与收到的CRC码不同，则他会发送反馈出错信息，利用错误帧请求它重新发送。

CRC部分的计算一般由CAN控制器硬件完成，出错时的处理由软件控制最大重发数。在CRC校验码滞后，有一个CRC界定符，它为隐形位，主要作用是把**CRC校验码与后面的ACK段间隔起来。**

##### · ACK段

ACK段包含一个ACK槽位，和ACK界定符位。类似12C总线，在ACK槽位中，**发送节点**发送的是**隐形位**，而**接收节点**在这一位中发送**显性位**以示应答。在ACK槽和帧结束之间由ACK界定符间隔开。

##### · 帧结束

EOF段（End Of Frame），译为帧结束，帧结束段由发送节点发送的7个隐形位表示结束

### STM32F407 CAN Controller介绍

![image.png](https://img-blog.csdnimg.cn/img_convert/ccb7524ca38799f533a201c16bd9fd45.png)

STM32的有两组CAN控制器，其中CAN1是主设备，框图中的存储访问控制器是由CAN1控制的，CAN2无法直接访问存储区域，所以使用CAN2的时候必须使用CAN1外设的时钟。框图中主要包含CAN控制内核，发送邮箱，接收FIFO以及验收筛选器，下面对框图中的各个部分进行介绍。

#### 3.1.1 主控制寄存器 CAN_MCR

主控制寄存器 CAN_MCR 负责管理CAN的工作模式，它使用以下寄存器位实现控制。

![image.png](https://img-blog.csdnimg.cn/img_convert/45306c4e8d03b4869d130b93f9c2015e.png)

##### (1)DBF调试冻结功能

DBF（Debug freeze）调试冻结，使用它可**设置CAN处于工作状态或禁止收发**的状态，禁止收发时仍可访问接收FIFO中的数据。这两种状态是当STM32芯片处于程序调试模式时才使用的，平时使用并不影响。

##### (2)TTCM时间触发模式

TTCM（Time triggered，communication mode）时间触发模式，它用于配置CAN的**时间触发通信模式**，在此模式下，CAN使用它内部定时器产生时间戳，并把它保存在CAN_RDTxR、CAN——TDTxR寄存器中。内部定时器在每个CAN位时间累加。

##### (3)ABOM自动离线管理

ABOM(Automatic bus-off management)自动离线管理，它用于**设置是否使用自动离线管理功能。当节点检测到它发送错误或接收错误超过一定值时，会自动进入离线状态。**

在离线状态中，CAN不能接收或者发送报文。处于离线状态的时候，可以软件控制恢复或者直接使用这个自动离线管理功能，它会在适当的时候自动恢复。

##### (4)AWUM自动唤醒

AWUM(Automatic bus-off management)，自动唤醒功能，CAN外设可以使用软件进入**低功耗的睡眠模式**，当CAN检测到总线活动的时候，会自动唤醒。

##### (5)NART自动重传

NART(No automatic retransmission)报文自动重传功能，设置这个功能后，当报文发送失败时会**自动重传至成功**为止。若不使用这个功能，无论发送结果如何，消息只发送一次。

##### (6)RFLM锁定模式

RFLM(Receive FIFO locked mode)FIFO锁定模式，该功能用于锁定接收FIFO。锁定后，**当接受FIFO溢出时，会丢弃下一个接收的报文**。若不锁定，则下一个接收到的报文会覆盖原报文。

(7)TXFP报文发送优先级的判定方法

TXFP(Transmit FIFO priority) **报文发送优先级的判定方法**，当CAN外设的发送邮箱中有多个待发送报文时，本功能可以控制它是根据报文的ID优先级还是报文存进邮箱的书序来发送。

#### 3.1.2 位时序寄存器（CAN_BTR）及波特率

![image.png](https://img-blog.csdnimg.cn/img_convert/70eb67efdfb747e77bd0c7c5929dec7c.png)

CAN外设中的位时序寄存器CAN_BTR用于**配置测试模式、波特率以及各种位内的段参数。**

###### 3.1.2.1 模式

位31 SILM：静默模式（调试）（Silent mode(debug)）

0：正常工作

1：静默模式

位30 LBKM：环回模式（调试）（Loop back mode(debug)）

0：禁止环回模式

1：使能换回模式

为方便调试，STM32的CAN提供了测试模式，配置位时序寄存器CAN_BTR的SILM及LBKM寄存器位可以控制使用正常模式、静默模式、回环模式以及静默回环模式。

![image.png](https://img-blog.csdnimg.cn/img_convert/e5d6aba5a39f0b0d626d0c82ae105f5e.png)

###### 3.1.2.2 位时序及波特率

STM32 外设的位时序与我们前面解释的CAN标准时序有一点区别，见图

![image.png](https://img-blog.csdnimg.cn/img_convert/4ac3adf669ac6c7b71b713724fb21efd.png)

STM32的CAN外设位时序中只包含3段，分别是同步段SYNC_SEG、位段BS1及位段BS2，采样点位于BS1及BS2段的交界处。

其中SYNC_SEG段固定长度位1Tq，而BS1及BS2段可以在位时序寄存器CAN_BTR设置它们的时间长度，它们可以在重新同步期间增长或缩短，该长度JSW也可在位时序寄存器中配置。

理解STM32的CAN外设的位时序时，可以把它的**BS1段理解为是由前面介绍的CAN标准协议中的PTS段和PBS1段合在一起的，而BS2段就相当于PBS2段。**

了解位时序后，我们可以配置波特率了。通过配置位时序寄存器CAN_BTR的TS1[3:0]及TS2[2:0]寄存器位设定BS1及BS2段的长度后，我们就可以确定每个CAN数据位的时间：

BS1段时间：TS1 = Tq x (TS1[3:0] + 1),

BS2段时间：TS2 = Tq x (TS2[2:0] + 1),

一个数据位的时间： T1bit **=** 1Tq + TS1 + TS2 **=** 1 + (TS1[3:0] + 1) + (TS2[2:0] + 1) **=** N Tq

其中单个时间片的长度Tq与CAN外设的所挂载的时间总线及分频器配置有关，CAN1和CAN2外都是挂载在APB1总线上的

而位时序寄存器CAN_BTR中的BRP[9:0]寄存器位可以设置

CAN波特率 =  Fpclk1/((CAN_BS1+CAN_BS2+1)*CAN_Prescaler)

其中clk为42M

#### 3.2 CAN发送邮箱

回到图 中的 CAN 外设框图，在标号处的是 CAN 外设的发送邮箱，它一共有 3 个发送邮箱，即**最多可以缓存 3 个待发送的报文**。

每个发送邮箱中包含有**标识符寄存器 CAN_TIxR**、**数据长度控制寄存器 CAN_TDTxR** 及 **2 个数据寄存器 CAN_TDLxR、CAN_TDHxR**，它们的功能见表：

![image.png](https://img-blog.csdnimg.cn/img_convert/bd23da88d68e892e77fa10a4fe9baced.png)

当我们要使用 CAN 外设发送报文时，把报文的各个段分解，按位置写入到这些寄存器中，并对标识符寄存器CAN_TIxR中的发送请求寄存器位TMIDxR_TXRQ置1，即可把数据发送出去。

其中标识符寄存器CAN_TIxR中的STDID寄存器位比较特别。我们知道CAN的标准标识符的总位数为11位，而扩展标识符的总位数为29位。

当报文使用扩展标识符的时候，标识符寄存器CAN_TIxR中的STDID[10:0]等效于EXTID[18:28]位，它与EXTID[17:0]共同组成完整的29位扩展标识符。

#### 3.3 CAN接收FIFO

图 中的 CAN 外设框图，在标号处的是 CAN 外设的接收 FIFO，它一共**有 2 个接收 FIFO**，每个 FIFO 中**有 3 个邮箱**，即**最多可以缓存 6 个接收到的报文。**

当接收到报文时，FIFO的报文计时器会自增，而 STM32 内部读取 FIFO 数据之后，报文计数器会自减。

我们通过状态寄存器可获知报文计数器的值，而通过前面著控制寄存器的RFLM位，可设置锁定模式，锁定模式下FIFO溢出时会丢弃新报文，非锁定下FIFO溢出时新报文会覆盖旧报文。

跟发送邮箱类似，每个接收FIFO中包含有**标识符寄存器**CAN_RlxR、**数据长度控制寄存器**CAN_RDTxR及**2个数据寄存器**CAN_RDLxR、CAN_RDHxR，它们的功能见表。

![image.png](https://img-blog.csdnimg.cn/img_convert/7d1bf703c7faedd74532622bf168ed44.png)

通过中断或状态寄存器知道接收 FIFO 有数据后，我们再读取这些寄存器的值即可把接收到的报文加载到 STM32 的内存中。

#### 3.4 验收筛选器

图中的 CAN 外设框图，在标号处的是 CAN 外设的验收筛选器，一共有 **28** 个筛选器组，每个筛选器组有 **2** 个寄存器，**CAN1 和 CAN2 共用的筛选器的**。

在CAN协议中，消息的标识符与节点地址无关，但与信息内容有关。因此，因此，发送节点将报文广播给所有接收器时，接收节点会**根据报文标识符**的值来确定软件是否需要该消息，为了简化软件的工作，STM32 的 CAN 外设接收报文前会**先使用验收筛选器检查**，只接收需要的报文到 FIFO中。

筛选器工作的时候，可以调整筛选ID的长度及过滤模式。根据筛选ID长度来分类。有以下两种：

(1) 检查 STDID[10:0]、EXTID[17:0]、IDE 和 RTR 位，一共 31 位。

(2) 检查 STDID[10:0]、RTR、IDE 和 EXTID[17:15]，一共 16 位。

通过配置筛选尺度寄存器 **CAN_FS1R** 的 **FSCx** 位可以**设置筛选器工作在哪个尺度**。而根据过滤的方法分为以下两种模式：

(1) **标识符列表模式**，它把要接收报文的 ID **列成一个表**，要求报文 ID 与列表中的某一个标识符**完全相同**才可以接收，可以理解为**白名单管理**。

(2) **掩码模式**，它把可接收报文 ID 的某几位作为列表，这几位被称为掩码，可以把它理解成关键字搜索，只要**掩码 (关键字) 相同，就符合要求**，报文就会被保存到接收 FIFO。通过配置筛选模式寄存器 CAN_FM1R 的 FBMx 位可以设置筛选器工作在哪个模式。不同的尺度和不同的过滤方法可使筛选器工作在图的4 种状态。
![image.png](https://img-blog.csdnimg.cn/img_convert/ab6df3e83885760170bd97e4c73f984b.png)

每组筛选器包含 **2 个 32 位**的寄存器，分别为 **CAN_FxR1** 和 **CAN_FxR2**，它们用来存储要筛选的ID 或掩码，各个寄存器位代表的意义与图中两个寄存器下面“映射”的一栏一致，各个模式的说明见表。

![image.png](https://img-blog.csdnimg.cn/img_convert/ca94c45eb2ce6b6653726966222ce8d1.png)

例如下面的表格所示，在掩码模式时，第一个寄存器存储要筛选的 ID，第二个寄存器存储掩码，**掩码为 1 的部分表示该位必须与 ID 中的内容一致**，筛选的结果为表中第三行的 ID 值，它是一组包含多个的 ID 值，其中 x 表示该位可以为 1 可以为 0。

![image.png](https://img-blog.csdnimg.cn/img_convert/fed2abbaf4bf363916324717b7e395e2.png)

而工作在标识符模式时，2 个寄存器存储的都是要筛选的 ID，它只包含 2 个要筛选的 ID 值 (32位模式时)。

如果使用了筛选器，且报文的 ID 与所有筛选器的配置都不匹配，CAN 外设会丢弃该报文，不存入接收 FIFO。

#### 3.5 整体控制逻辑

回到结构框图，图中的标号处表示的是 CAN2 外设的结构，它与 CAN1 外设是一样的，他们共用筛选器且由于存储访问控制器由 CAN1 控制，所以要**使用 CAN2 的时候必须要使用CAN1 的时钟**。其中 STM32F103 系列芯片不具有 CAN2 控制器。

#### 3.6 STM32 HAL代码逻辑

##### 3.6.1 初始化

采用很新的**1.25.2，最新的库还是差异挺大的！**

使用STM32 HAL 库提供的各种结构体及库函数可以简化这些控制过程。跟其它外设一样，STM32HAL 库提供了 CAN 初始化结构体及初始化函数来控制 CAN 的工作方式，提供了收发报文使用的结构体及收发函数，还有配置控制筛选器模式及 ID 的结构体。这些内容都定义在库文件“**STM32F4xx_hal_can.h**”及“**STM32F4xx_hal_can.c**”中，编程时我们可以结合这两个文件内的注释使用或参考库帮助文档。首先我们来学习初始化结构体的内容，见代码清单 1。


```c
typedef struct
{
  uint32_t Prescaler;  /* 配置 CAN 外设的时钟分频，可设置为 1-1024*/
  uint32_t Mode;       /* 配置 CAN 的工作模式，回环或正常模式 */
  uint32_t SyncJumpWidth;  /* 配置 SJW 极限值 */
  uint32_t TimeSeg1;   /* 配置 BS1 段长度 */
  uint32_t TimeSeg2;   /* 配置 BS2 段长度 */
  FunctionalState TimeTriggeredMode;   /* 是否使能 TTCM 时间触发功能 */
  FunctionalState AutoBusOff;     /* 是否使能 ABOM 自动离线管理功能 */
  FunctionalState AutoWakeUp;   /* 是否使能 AWUM 自动唤醒功能 */
  FunctionalState AutoRetransmission;  /* 是否使能 NART 自动重传功能 */
  FunctionalState ReceiveFifoLocked;   /* 是否使能 RFLM 锁定 FIFO 功能 */
  FunctionalState TransmitFifoPriority;/* 配置 TXFP 报文优先级的判定方法 */
} CAN_InitTypeDef;
```

代码清单 CAN 初始化结构体这些结构体成员说明如下，其中括号内的文字是对应参数在 STM32 HAL 库中定义的宏：

(1) Prescaler

本成员设置 CAN 外设的**时钟分频**，它可**控制时间片 Tq 的时间长度**，这里设置的值最终会减 1 后再写入 BRP 寄存器位，即前面介绍的 Tq 计算公式：

Tq = (BRP[9:0]+1) x TPCLK

等效于：Tq = CAN_Prescaler x TPCLK

(2) Mode

本成员设置 CAN 的**工作模式**，可设置为正常模式 (CAN_MODE_NORMAL)、回环模式 (CAN_MODE_LOOPBACK)、静默模式 (CAN_MODE_SILENT) 以及回环静默模式(CAN_MODE_SILENT_LOOPBACK)。

(3) SyncJumpWidth

本成员可以配置 **SJW 的极限长度**，即 **CAN 重新同步时单次可增加或缩短的最大长度**，它可以被配置为 1-4Tq(CAN_SJW_1/2/3/4tq)。

(4) TimeSeg1

本成员用于设置 CAN 位时序中的 **BS1 段的长度**，它可以被配置为 1-16 个 Tq 长度(CAN_BS1_1/2/3…16tq)。

(5) TimeSeg2

本成员用于设置 CAN 位时序中的 **BS2 段的长度**，它可以被配置为 1-8 个 Tq 长度(CAN_BS2_1/2/3…8tq)。SYNC_SEG、 BS1 段及 BS2 段的长度加起来即一个数据位的长度，即前面介绍的原来

计算公式：T1bit =1Tq+TS1+TS2=1+ (TS1[3:0] + 1)+ (TS2[2:0] + 1)

等效于：T1bit= 1Tq+CAN_BS1+CAN_BS2

(6) TimeTriggeredMode

本成员用于设置**是否使用时间触发功能** (ENABLE/DISABLE)，时间触发功能在某些CAN 标准中会使用到。

(7) AutoBusOff

本成员用于设置**是否使用自动离线管理** (ENABLE/DISABLE)，使用自动离线管理可以在节点出错离线后适时自动恢复，不需要软件干预。

(8) AutoWakeUp

本成员用于设置**是否使用自动唤醒功能** (ENABLE/DISABLE)，使能自动唤醒功能后它会在监测到总线活动后自动唤醒。

(9) AutoWakeUp

本成员用于设置**是否使用自动离线管理功能** (ENABLE/DISABLE)，使用自动离线管理可以在出错时离线后适时自动恢复，不需要软件干预。

(10) AutoRetransmission

本成员用于设置**是否使用自动重传功能** (ENABLE/DISABLE)，使用自动重传功能时，会一直发送报文直到成功为止。

(11) ReceiveFifoLocked

本成员用于设置**是否使用锁定接收** FIFO(ENABLE/DISABLE)，锁定接收 FIFO 后，若FIFO 溢出时会丢弃新数据，否则在 FIFO 溢出时以新数据覆盖旧数据。

(12) TransmitFifoPriority

本成员用于设置**发送报文的优先级判定方法** (ENABLE/DISABLE)，使能时，以报文存入发送邮箱的先后顺序来发送，否则按照报文 ID 的优先级来发送。配置完这些结构体成员后，我们调用库函数 HAL_CAN_Init 即可把这些参数写入到 CAN 控制寄存器中，实现 CAN 的初始化


